#!/bin/sh

base="refs/remotes"
format="%(refname:short) origin/master"
options="--no-merges"
filter="grep -v origin/HEAD"

for argument in $@; do
    case "$argument" in
        '-l'|'--local')
            base="refs/heads"
            format="%(refname:short) %(upstream:short)"
            ;;
        '-m'|'--merges')
            options=""
            ;;
        '--head'|'--include-head')
            filter="cat"
            ;;
        *)
            echo "Unknown option $argument" >&2
            exit 1
            ;;
    esac
done
(
echo Branch#Behind#Ahead#Relative to
git for-each-ref --format="$format" $base | \
$filter | \
while read local remote
do
    [ -z "$remote" ] && continue
    BEHIND=$(git rev-list $options ${local}..${remote} --count)
    AHEAD=$(git rev-list $options ${remote}..${local} --count)
    echo "$local#-$BEHIND#+$AHEAD#$remote"
done) | column -t -s '#'
