#!/bin/sh

case "$1" in
'-m' | '--master')
    format="%(refname:short) origin/master"
    ;;
*)
    format="%(refname:short) %(upstream:short)"
    ;;
esac

git for-each-ref --format="$format" refs/heads | \
while read local remote
do
    [ -z "$remote" ] && continue
    git rev-list --left-right --no-merges ${local}...${remote} -- 2>/dev/null >/tmp/git_upstream_status_delta || continue
    BEHIND=$(grep -c '^>' /tmp/git_upstream_status_delta)
    AHEAD=$(grep -c '^<' /tmp/git_upstream_status_delta)
    echo "$local (behind $BEHIND) | (ahead $AHEAD) $remote"
done
