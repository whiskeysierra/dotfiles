#!/usr/bin/env bash

set -e

git fetch

build_command='mvn clean verify -P integration-test'

if [ $# -ge 1 ]; then
    notify_commit=$(git rev-parse origin/pull-request/source/$1)
    build_branch=pull-request/merge/$1
    previous_branch=$(git rev-parse --abbrev-ref HEAD)

    function rollback() {
        git checkout $previous_branch
        git branch -D $build_branch
    }

    git checkout $build_branch
    trap rollback EXIT INT TERM

    if [ $# -ge 2 ]; then
        shift
        build_command=$@
    fi
else
    notify_commit=$(git rev-parse HEAD)
fi

function failure() {
    ci-fake failure $notify_commit
}

ci-fake progress $notify_commit
trap failure ERR
$build_command
ci-fake success $notify_commit

