#!/bin/sh -e

: ${2?"Usage: $0 <org> <repo>"}

auth="Authorization:token b4e37c731ffcd079e5b85d610df7cd22a7cb40db"

http https://api.github.com/repos/$1/$2/releases "${auth}" | \

    ~/Downloads/jq-linux64 -r '
    map({tag_name, created_at, url}) | 
    to_entries as $releases | 
    INDEX($releases[]; .key) as $index | 
    JOIN($index; $releases[]; .key | . + 1 | tostring; {left: .[0].value, right: .[1].value}) | 
    select(.left != null and .right != null) | 
    [.left.url, .left.tag_name, .right.tag_name] |
    @tsv' | \

    while read url current previous; do
        http --ignore-stdin PATCH ${url} "${auth}" body="https://github.com/$1/$2/compare/${previous}..${current}"
    done

