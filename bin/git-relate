#!/bin/sh

base="refs/remotes"
format="%(refname:short) origin/master"
options=""

for argument in $@; do
    case "$argument" in
        '-l'|'--local')
            base="refs/heads"
            format="%(refname:short) %(upstream:short)"
            ;;
        '-n'|'--no-merges')
            options="$options --no-merges"
            ;;
         '-e'|'--no-empty')
            options="$options --remove-empty"
            ;;
        *)
            echo "Unknown option $argument" >&2
            exit 1
            ;;
    esac
done
(echo Branch#Behind#Ahead#Relative to
git for-each-ref --sort="refname:short" --format="$format" $base | \
grep -v origin/HEAD | \
while read local remote
do
    [ -z "$remote" ] && continue
    BEHIND=$(git rev-list $options ${local}..${remote} --count)
    AHEAD=$(git rev-list $options ${remote}..${local} --count)
    echo "$local#-$BEHIND#+$AHEAD#$remote"
done) | column -t -s '#'
